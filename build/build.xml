<?xml version="1.0" encoding="UTF-8"?>
<project name="whp-report" xmlns:flyway="antlib:com.googlecode.flyway.ant">

    <path id="flyway.lib.path">
        <fileset dir="../build/lib" includes="*.jar"/>
    </path>


    <taskdef uri="antlib:com.googlecode.flyway.ant"
             resource="com/googlecode/flyway/ant/antlib.xml"
             classpathref="flyway.lib.path"/>

    <condition property="project.dir" value="${parent.basedir}" else="${basedir}/../">
        <isset property="${parent.basedir}"/>
    </condition>

    <target name="clean.existing.schema">
        <echo message="Cleaning all schema"/>
        <flyway:clean driver="org.postgresql.Driver"
                      url="jdbc:postgresql://localhost/whp/"
                      user="postgres"
                      password="p@ssw0rd"
                      schemas="whp_reports"
                      classpathref="flyway.lib.path"/>
    </target>

    <target name="drop.db">
        <exec executable="dropdb">
            <arg line="-U postgres whp"/>
        </exec>
    </target>

    <target name="create.db">
        <exec executable="createdb">
            <arg line="-U postgres whp"/>
        </exec>
    </target>

    <target name="setup.schema">
        <echo message="Setting up schema"/>
        <exec executable="psql">
            <arg line="-U postgres"/>
	    <arg line="-d whp"/>
            <arg line="-f ${project.dir}/whp-reports-migration/src/main/resources/db/setup/base_setup.sql"/>
        </exec>

    </target>

    <target name="init.schema">
        <flyway:init driver="org.postgresql.Driver"
                     url="jdbc:postgresql://localhost/whp/"
                     user="postgres"
                     password="p@ssw0rd"
                     schemas="whp_reports"
                     classpath="${runtime-classpath}"
                     initialVersion="0"
                     initialDescription="Base setup"/>
    </target>

    <target name="migrate.data">
        <echo message="Applying schema migrations"/>
        <flyway:migrate driver="org.postgresql.Driver"
                        url="jdbc:postgresql://localhost/whp/"
                        user="postgres"
                        password="p@ssw0rd"
                        schemas="whp_reports"
                        baseDir="/db/migration"
                        classpathref="flyway.lib.path"/>
    </target>
</project>
